[Third Man Alert Template]
description = Clone this saved search to create your thirdman alert
dispatch.earliest_time = rt-1mon@d
dispatch.latest_time = rt+5m@m
search = | pivot Authentication Successful_Authentication count(Successful_Authentication) SPLITROW _time PERIOD second SPLITROW user SPLITROW app SPLITROW src SPLITROW dest | lookup dnslookup clienthost as src | eval src_ip=coalesce(ip,src) | lookup tm_asn ip as src_ip | eval date_hour=strftime(_time,"%H") | eval period=case(date_hour<5, 0, date_hour<8, 1, date_hour<12, 2, date_hour<17, 3, date_hour<20, 4, date_hour<24, 5) | eventstats count as as_count by user, autonomous_system | eventstats count as period_count by user, period | eventstats count as wday_count by user, date_wday | eventstats count as app_count by user, app | eventstats count as dest_count by user, dest | eval unique_vectors=if(as_count=1,1,0)+if(period_count=1,1,0)+if(wday_count=1,1,0)+if(app_count=1,1,0)+if(dest_count=1,1,0) | eventstats min(_time) as user_start by user | where unique_vectors>2 AND _time>(user_start+604800)
